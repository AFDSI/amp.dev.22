From 7445efb361f79fa9f84119f415d02063863b529f Mon Sep 17 00:00:00 2001
From: Claude <noreply@anthropic.com>
Date: Tue, 16 Dec 2025 00:56:28 +0000
Subject: [PATCH] Enable amp-site-search by adding template includes and fixing
 URL

- Add search block to default.j2 and amp-dev.ejs templates
- Add search trigger button to both header.j2 partials
- Add search-trigger CSS include to partials/header.j2
- Fix search pagination URL to amp-new.netlify.app (correct for amp.dev.22)
- Document changes in _claude/branches/

The search files already exist in amp.dev.22 but were deprecated by removing
includes from the build stream. This re-enables them for local testing.
---
 _claude/branches/amp-site-search-migration.md | 71 +++++++++++++++++++
 frontend/templates/layouts/default.j2         |  4 ++
 .../templates/views/2021/partials/header.j2   | 12 ++++
 frontend/templates/views/partials/header.j2   | 15 +++-
 frontend21/amp-dev.ejs                        |  4 ++
 netlify/functions/search_do/search_do.js      |  2 +-
 6 files changed, 106 insertions(+), 2 deletions(-)
 create mode 100644 _claude/branches/amp-site-search-migration.md

diff --git a/_claude/branches/amp-site-search-migration.md b/_claude/branches/amp-site-search-migration.md
new file mode 100644
index 000000000..4c32ace68
--- /dev/null
+++ b/_claude/branches/amp-site-search-migration.md
@@ -0,0 +1,71 @@
+# amp-site-search Migration Branch
+
+**Branch:** `claude/analyze-repo-migration-rTuxm`
+**Feature:** amp-site-search
+**Status:** Applied and ready for testing
+
+## Overview
+
+This branch migrates the amp-site-search feature from amp.dev.20 to amp.dev.22. The search functionality was deprecated by removing includes from the build stream, but the underlying files still exist in amp.dev.22.
+
+## Changes Applied
+
+### 1. Template Changes (Re-enabled search includes)
+
+#### `frontend/templates/layouts/default.j2`
+- Added search block include after analytics block:
+```jinja2
+{% block search %}
+{% include 'views/partials/search.j2' %}
+{% endblock %}
+```
+
+#### `frontend21/amp-dev.ejs`
+- Added search block include after analytics block (same as default.j2)
+
+#### `frontend/templates/views/2021/partials/header.j2`
+- Added magnifier icon include
+- Added search trigger button div with tap handler for searchLightbox
+
+#### `frontend/templates/views/partials/header.j2`
+- Added CSS include: `{% do doc.styles.addCssFile('/css/components/molecules/search-trigger.css') %}`
+- Added magnifier icon include
+- Added search trigger button div
+- Updated language-selector CSS include path to `language-selector-2021.css`
+
+### 2. URL Configuration
+
+#### `netlify/functions/search_do/search_do.js`
+- Changed URL to `https://amp-new.netlify.app/` (correct for amp.dev.22 Google Search Console crawling)
+
+### 3. CSS Changes (Already applied in previous commit)
+
+The CSS changes for magnifier spacing were applied in commit `135d9b5a9`:
+- `frontend/scss/components/molecules/search-trigger.scss` - margin and align-self
+- `frontend21/scss/components/search-trigger.scss` - margin adjustment
+
+## Files NOT Changed (Already Identical)
+
+The following files were verified identical between amp.dev.20 and amp.dev.22:
+- `platform/lib/routers/search.js`
+- `platform/lib/utils/googleSearch.js`
+- `platform/config/search-promoted-pages.json`
+- `frontend/templates/views/partials/search.j2`
+- `pages/static/serviceworker.js`
+- `frontend/icons/magnifier.svg`
+- `frontend/icons/close.svg`
+- `frontend/icons/internal.svg`
+
+## Testing
+
+To test locally:
+1. Run `npm run develop` or the local development server
+2. Verify the magnifier icon appears in the header
+3. Click the magnifier to open the search lightbox
+4. Enter a search query and verify results appear
+
+## Environment Requirements
+
+Search functionality requires valid Google Programmable Search Engine credentials:
+- `GOOGLE_CUSTOM_SEARCH_ID`
+- `GOOGLE_SEARCH_API_KEY`
diff --git a/frontend/templates/layouts/default.j2 b/frontend/templates/layouts/default.j2
index da90cb386..533282a4e 100644
--- a/frontend/templates/layouts/default.j2
+++ b/frontend/templates/layouts/default.j2
@@ -134,6 +134,10 @@
     {% include 'views/partials/consent.j2' %}
     {% endblock %}
 
+    {% block search %}
+    {% include 'views/partials/search.j2' %}
+    {% endblock %}
+
     {% block serviceWorker %}
     {% include 'views/partials/service-worker.j2' %}
     {% endblock %}
diff --git a/frontend/templates/views/2021/partials/header.j2 b/frontend/templates/views/2021/partials/header.j2
index ae97e13dc..7dbbcdda9 100644
--- a/frontend/templates/views/2021/partials/header.j2
+++ b/frontend/templates/views/2021/partials/header.j2
@@ -83,6 +83,18 @@ to provide its state to other components #}
       {% endfor %}
     </nav>
 
+    {% do doc.icons.useIcon('/icons/magnifier.svg') %}
+
+    <div id="searchTriggerOpen"
+         class="ap-m-search-trigger"
+         on="tap:searchLightbox"
+         role="button"
+         tabindex="0">
+      <div class="ap-a-ico ap-m-search-trigger-icon">
+        <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#magnifier"></use></svg>
+      </div>
+    </div>
+
     {# blog.amp.dev shares the header with amp.dev but isn't localized.
        Therefore it's nice to have a way to turn off the language selector #}
     {% if language_selector != False %}
diff --git a/frontend/templates/views/partials/header.j2 b/frontend/templates/views/partials/header.j2
index c639b29fe..6c7aec2dd 100644
--- a/frontend/templates/views/partials/header.j2
+++ b/frontend/templates/views/partials/header.j2
@@ -79,6 +79,7 @@
     {# Resources need to be added outside the cached partial #}
     {% do doc.styles.addCssFile('/css/components/organisms/header.css') %}
     {% do doc.styles.addCssFile('/css/components/molecules/nav-link.css') %}
+    {% do doc.styles.addCssFile('/css/components/molecules/search-trigger.css') %}
     {% do doc.icons.useIcon('/icons/logo.svg') %}
     {% do doc.icons.useIcon('/icons/angle-down-solid.svg') %}
 
@@ -95,10 +96,22 @@
     {{ doc.pod.amp_dev.template_cache.get(cache_key)|safe }}
     {% endif %}
 
+    {% do doc.icons.useIcon('/icons/magnifier.svg') %}
+
+    <div id="searchTriggerOpen"
+         class="ap-m-search-trigger"
+         on="tap:searchLightbox"
+         role="button"
+         tabindex="0">
+      <div class="ap-a-ico ap-m-search-trigger-icon">
+        <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#magnifier"></use></svg>
+      </div>
+    </div>
+
     {# blog.amp.dev shares the header with amp.dev but isn't localized.
        Therefore it's nice to have a way to turn off the language selector #}
     {% if language_selector != False %}
-    {% do doc.styles.addCssFile('/css/components/molecules/language-selector.css') %}
+    {% do doc.styles.addCssFile('/css/components/atoms/language-selector-2021.css') %}
     <div class="ap-m-language-selector">
       <span class="ap-m-language-selector-label" aria-label="{{ _('Select a language') }}" tabindex="-1">
         <span class="ap-m-nav-link">{{ doc.locale.language|upper }}</span>
diff --git a/frontend21/amp-dev.ejs b/frontend21/amp-dev.ejs
index af493cbf3..e7e8ba64e 100644
--- a/frontend21/amp-dev.ejs
+++ b/frontend21/amp-dev.ejs
@@ -135,6 +135,10 @@
     {% include 'views/partials/consent.j2' %}
     {% endblock %}
 
+    {% block search %}
+    {% include 'views/partials/search.j2' %}
+    {% endblock %}
+
     {% block serviceWorker %}
     {% include 'views/partials/service-worker.js' %}
     {% endblock %}
diff --git a/netlify/functions/search_do/search_do.js b/netlify/functions/search_do/search_do.js
index 657fd74ad..ba398c120 100644
--- a/netlify/functions/search_do/search_do.js
+++ b/netlify/functions/search_do/search_do.js
@@ -89,7 +89,7 @@ function createResult(
       encodeURIComponent(query) +
       '&locale=' +
       encodeURIComponent(locale) +
-      '&page=https://amp.dev/'
+      '&page=https://amp-new.netlify.app/'
   ).toString();
 
   if (page < lastPage && page < LAST_PAGE) {
-- 
2.43.0
